<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Pre-processing &#8212; Palantiri v0.4 Manual</title>
    <link rel="stylesheet" href="_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="syn.conf" href="configuration/synthetic.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    
    
    <script type="text/javascript" src="_static/jquery.gifplayer.js"></script>
    <link rel="stylesheet" type="text/css" href="_static/gifplayer.css">
    <!-- Piwik -->
    <script type="text/javascript">
      var _paq = _paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//pyrocko.org/pwk/";
        _paq.push(['setTrackerUrl', u+'piwik.php']);
        _paq.push(['setSiteId', '1']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <noscript>
    <img src="https://pyrocko.org/pwk/piwik.php?idsite=1&rec=1" style="border:0" alt="" />
    </noscript>

  </head><body>

    <div class="related">
      <h3>Navigation</h3>
        <ul>
          <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
          <li>
            <img src='https://git.pyrocko.org/repo-avatars/13' class='pyrocko-button' onclick="window.location = https://git.pyrocko.org/asteinbe/Palantiri';">
          </li>
           &#187;
          <li>
              <a href="index.html">Palantiri v0.4 Manual</a> &#187;
          </li> 
        </ul>
    </div>
    

  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="pre-processing">
<h1>Pre-processing<a class="headerlink" href="#pre-processing" title="Permalink to this headline">¶</a></h1>
<p>Please make sure that you have configured the configuration files beforehand, as detailed in the configuration section.
Palantiri is a command line tool.</p>
<p>As a first step we need to search for an event to work on:</p>
<div class="section" id="event-search">
<h2>1. Event search<a class="headerlink" href="#event-search" title="Permalink to this headline">¶</a></h2>
<p>The event search is carried out by:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> palantiri_eventsearch
<span class="go">Usage: palantiri_eventsearch</span>
</pre></div>
</div>
<p>A list is returned in the terminal with the ISC event ids of the found earthquakes.</p>
</div>
<div class="section" id="event-folder-creation">
<h2>2. Event folder creation<a class="headerlink" href="#event-folder-creation" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>We can now use the id found in step 1 to create an event folder for the selected earthquake by:</p>
</div></blockquote>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> palantiri_create
<span class="go">Usage: palantiri_create eventid</span>
</pre></div>
</div>
<p>An eventfolder is created in the palantiri main workdir under the events folder with the event name and date as folder name. The folder contains some example configuration files
and a basic folder structure:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">eventname_date/</span>
<span class="go">|-- eventname_date.config           # (1)</span>
<span class="go">            |-- eventname_date.syn                    # (2)</span>
<span class="go">            |--eventname_date.origin                # (3)</span>
<span class="go">`-- data/</span>
<span class="go">            `-- work/</span>
<span class="go">                    `-- semblance</span>
</pre></div>
</div>
</div>
<div class="section" id="a-data-download">
<h2>2 a) Data download<a class="headerlink" href="#a-data-download" title="Permalink to this headline">¶</a></h2>
<p>Download real data with the download tool:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">            $</span> palantiri_down
<span class="go">usage: palantiri_down [options] &lt;eventname_date&gt;  &quot;&lt;YYYY-MM-DD HH:MM:SS&gt;&quot; &lt;lat&gt; &lt;lon&gt; \\</span>
<span class="go">                               &lt;depth_km&gt; &lt;radius_km&gt; &lt;fmin_hz&gt; \\</span>
<span class="go">                               &lt;sampling_rate_hz&gt; \\</span>
<span class="go">                               &lt;eventname&gt; [--]</span>

<span class="go">       palantiri_down [options] &lt;eventname_date&gt; &quot;&lt;YYYY-MM-DD HH:MM:SS&gt;&quot; &lt;radius_km&gt; &lt;fmin_hz&gt; \\</span>
<span class="go">                               &lt;sampling_rate_hz&gt; &lt;eventname&gt; [--]</span>

<span class="go">       palantiri_down [options] &lt;eventname_date&gt;  &lt;catalog-eventname&gt; &lt;radius_km&gt; &lt;fmin_hz&gt; \\</span>
<span class="go">                               &lt;sampling_rate_hz&gt; &lt;eventname&gt; [--]</span>

<span class="go">       palantiri_down [options] --window=&quot;&lt;YYYY-MM-DD HH:MM:SS, YYYY-MM-DD HH:MM:SS&gt;&quot; \\</span>
<span class="go">                               &lt;eventname_date&gt;  &lt;lat&gt; &lt;lon&gt; &lt;radius_km&gt; &lt;fmin_hz&gt; \\</span>
<span class="go">                               &lt;sampling_rate_hz&gt; &lt;eventname&gt; [--]</span>
</pre></div>
</div>
</div>
<div class="section" id="b-synthetic-data-generation">
<h2>2 b) Synthetic data generation<a class="headerlink" href="#b-synthetic-data-generation" title="Permalink to this headline">¶</a></h2>
<p>For generating synthetic data for palantiri, two options exist.
First you can use the station distributions you obtained from downloading using the palantiri_down command.
This is recommend to check the array response and the sensitivity in preparation for a real data analysis.</p>
<p>For this you will need a greensfunctions store that is pre-calculated with the fomosto tool from pyrocko (<a class="reference external" href="https://pyrocko.org/docs/current/apps/fomosto/index.html">https://pyrocko.org/docs/current/apps/fomosto/index.html</a>).
Several already pre-calculated stores for download can be found at <a class="reference external" href="http://kinherd.org:8080/gfws/static/stores/">http://kinherd.org:8080/gfws/static/stores/</a>
This possibilty assumes also that you downloaded data with a) or b), as the real station distributions will be used for the synthetics.
Please make sure to set the pyrocko_download option in the event config file to 1 if you downloaded data with this command.
Also the noise of the real data will be used to perturb the synthetics if you select the option in the event config file.</p>
<p>As a second option we offer to use the output of the colosseo scneario generator.</p>
<p>You can also use the output of the pyrocko scenario generator colosseo.
After you followed the steps to create a purely synthetic dataset at <a class="reference external" href="https://pyrocko.org/docs/current/apps/colosseo/index.html">https://pyrocko.org/docs/current/apps/colosseo/index.html</a>
you have to give the scenario.yml of the scenario as input in the event configuration file and set the variable colosseo input to
1. Please make sure that you unset other types of input. Also give the greensfunctions store used in the synthetic input file
(eventname_date.syn). Disregard all other parameters in the synthetic input file for this case, as the generated event from the scenario
will be used. You will need to merge all mseed files in the scenarios waveform directory into one file called scenario.mseed, located
in the same folder as the scenario.yml. This can be done with jackseis or simply by using cat.</p>
</div>
<div class="section" id="array-clustering">
<h2>3. Array clustering<a class="headerlink" href="#array-clustering" title="Permalink to this headline">¶</a></h2>
<p>In this step we cluster the stations into virtual arrays, based on the configuration in the eventname_date.config. This is handled as an kmeans problem and returns a set of virtual arrays.
The command to cluster the stations into virtual arrays is:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> palantiri_cluster
<span class="go">Usage: palantiri_cluster eventname_date</span>
</pre></div>
</div>
<p>The desired stations in each array can be given/modified in the eventname_date.config file, also allowing for manual array creation.
As input a comma separated list of station names is expected in the format:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Network.Station..Channel</span>
</pre></div>
</div>
<p>The output arrays are numbered and assigned a prefix <code class="docutils literal notranslate"><span class="pre">r</span></code>. Note that the numbering might not be consecutive as some arrays will be disregarded after the clustering because of the settings in the configuration file (distance from source to stations, distance between arrays).</p>
<p>Each array can also be given a reference station (<code class="docutils literal notranslate"><span class="pre">arrayrefstation</span></code>) which will be used for cross-correlation and plotting purposes.
If not given the station which is closest to the center of the array will be used as reference.</p>
</div>
</div>
<div class="section" id="processing">
<h1>Processing<a class="headerlink" href="#processing" title="Permalink to this headline">¶</a></h1>
<p>The last step is the actual processing.
This chapter describes the main processing. After the pre-processing you will have a folder named after the specific event in the events subfolder and your eventname_date.config file contains a list of arrays.
The eventfolder will contain all work and data specific to this event. If you reprocess a certain event the results will be overwritten.
For beamforming several methods are incorporated, including linear, phase-weighted and coherence based stacking.</p>
<p>The MUSIC algorithm is at this stage partly supported but will be fully implemented in later versions.</p>
<p>The next steps are based on the input you have chosen before. Be sure to not mix different types of input. Remove or move the folders eventname_date/cluster and
eventname_date/work if you want to start over for different input or array setup.
Again be careful to check the eventname_date.config file in the event folder and adjust it your liking.
Note that the option for several filters are build in. With this option the processing will be done separately for different filter setups
and according outputs are generated. An arbitrary number of filter can used. The filter parameters names are assumed to be consecutively numbered.   This processing of different filter settings is useful for exploring e.g. high- and low-frequency content.
Also note that several depths can be selected to iterate over. Else only one -planar (equi-depth)- grid is considered for the semblance and traveltime
calculation. If several depths are chosen the processing will be repeated for each depth and the semblance will be output for each depth.
Arrays can be weighted by pre-event noise variance and azimuthal coverage.</p>
<p>The semblance output is located in the eventfolder/work/semblance as txt files with the ending <code class="docutils literal notranslate"><span class="pre">.asc</span></code>. They are</p>
<p>First the data of each array can be cross-correlated. Stations under the threshold (xcorrtreshold) given in the eventname_date.config are disregarded. They are crosscorrelated by default to the first station of the array but a reference station can be manually given to each array.       xcorr=1 enables a correction of timeshifts at each based on cross correlations. If also autoxcorrcorrectur = 1 is selected for each array a manual picking of phase onsets is done before the processing. This will return a reference waveform of one of the stations
in the virtual array in a figure and a snuffler window.  Marker for STA/LTA and theoretical phase onsets will be given.
After closing both figures, the user can then input a manual traveltime shift in second in regard to the xcorr window start (also markers in the snuffler). The traveltimes for this array will than be statically corrected using this manual selected value. Both methods allows for handling of velocity model inadequacies.</p>
<p>Second the traveltimes for each gridpoint to each station will be pre-calculated. This can take some time, depending on your gridsize. The traveltime grids are
saved automatically in the folder tttgrids for each array separately. They will automatically be loaded in when starting step 5 again. This is very useful for synthetic
test as it saves a lot of time. If you change the setup of arrays however you will have to delete the saved tttgrid files for the affected arrays. If the dimensions of the grid change they will have to be calculated again as well.</p>
<p>Lastly for the semblance calculation two options exists. Firstly the semblance can be calculated for each array separately and then combined. The combination can be weighted by the average SNR of the arrays if the option
is chosen in the eventname_date.config. The output are grids for each timestep of semblance which are stored in eventname_date/work/semblance for each array in a different folder with the ending
.asc. The combined semblance for all arrays can be found directly in eventname_date/work/semblance also with the ending <code class="docutils literal notranslate"><span class="pre">*.asc</span></code>. If you used multiple filter, the files will have a numeral matching the
listing of the filter. Also for each depth chosen a different output will be generated.</p>
<p>The actual processing is carried out by calling the bat command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> bat
<span class="go">Usage: bat process eventname_date</span>
</pre></div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
    &nbsp;
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="configuration/synthetic.html" title="syn.conf"
             accesskey="P">previous</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, The Palantiri Developers.
    </div>
  </body>
</html>